<html>

<head>
    <script src="https://code.jquery.com/jquery-1.11.3.js"></script>
    <style>
        .overlay {
            display: none;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background-color: black;
            opacity: .5
        }

        .dialog {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: auto;
            margin: 0;
            padding: 20px;
            border: 2px solid red;
            text-align: center;
            background-color: white;
        }
    </style>
    <script type="text/javascript">
        var DATA_PRODUCT_ID_ATTR = 'data-product-id';
        var DATA_DISPLAY_NAME_ATTR = 'data-display-name';
        var DATA_ICON_PATH_ATTR = 'data-icon-path';
        var DATA_LINK_MEDIA_TYPE_ATTR = 'data-link-media-type';
        var DATA_ROLE_ID = 'data-role-id';
        var DATA_BLRS_ATTR = 'data-blrs';
        var DATA_SITE_ID = 'data-site-id';
        var DATA_VERTICAL_ID = 'data-vertical-id';
        var DATA_ROLE_ID = 'data-vertical-id';
        var REL = 'rel';


        function removeAttributes(anchorHtml) {
            return anchorHtml
                .replace(_regexHref, '')
                .replace(_regexProductId, '')
                .replace(_regexRel);
        }

        function getHrefAttribute(product) {
            const { affiliateLink } = product;

            return `href="${affiliateLink}"`;
        }

        function getIconPathAttribute(product) {
            const { iconPath } = product;

            if (iconPath) {
                return `${DATA_ICON_PATH_ATTR}="${iconPath}"`;
            }

            return '';
        }

        function getProductIdAttribute(product) {
            const { productId } = product;

            if (productId) {
                return `${DATA_PRODUCT_ID_ATTR}="${productId}"`;
            }

            return '';
        }

        function getDisplayNameAttribute(product) {
            const { displayName = '' } = product;

            if (displayName) {
                return `${DATA_DISPLAY_NAME_ATTR}="${displayName}"`;
            }

            return '';
        }
        $.cleanNewVals = function () {
            $('#new-data-display-name').val("");
            $('#new-data-product-id').val("");
            $('#new-data-link-media-type').val("");
            $('#new-data-blrs').val("");
            $('#new-data-site-id').val("");
            $('#new-data-vertical-id').val("");
            $('#new-data-anchor-value').val("");
        }

        $.getNewValFromForm = function (key) {
            console.log($(`#new-data-${key}`).val());
            console.log($(`#current-data-${key}`).val());
            return $(`#new-data-${key}`).val().length > 0 ?
                ` data-${key}="${$(`#new-data-${key}`).val()}"` :
                $(`#current-data-${key}`).val().length > 0 ? ` data-${key}="${$(`#current-data-${key}`).val()}"` : "";
        }
        $.LinkConverter = async function (html) {
            // alert(html);
            var overlay = $("#overlay");
            var dialog = $("#dialog");
            var newAnchor = '';
            const regexAnchorMatch = /<a([^>]*)>([\s\S]*?)<\/a>/gm;
            const regexAnchor = () => /<a([^>]*)>([\s\S]*?)<\/a>/;
            const _regexAnchor = regexAnchor();

            const regexCtaButtonLink = /class=['"].*?cta-button[^'"]*/;
            const regexProductLink = /class=['"].*?nilink[^'"]*/;

            let textToReplaceArray = (html.match(regexAnchorMatch) || []);
            console.log('textToReplaceArray', textToReplaceArray);

            for (let i = 0; i < textToReplaceArray.length; i++) {
                let textToReplace = _regexAnchor.exec(textToReplaceArray[i]);
                console.log('textToReplace = ', textToReplaceArray[i]);

                //await $.product_modal($.convertProductLink(textToReplace[0], textToReplace[1], textToReplace[2]));

                let res = await $.product_modal($.convertProductLink(textToReplace[0], textToReplace[1], textToReplace[2])).then(() => {

                    let dispName = $.getNewValFromForm('display-name');
                    let prodId = $.getNewValFromForm('product-id');
                    let linkMediaType = $.getNewValFromForm('link-media-type');
                    let blrs = $.getNewValFromForm('blrs');
                    let siteId = $.getNewValFromForm('site-id');
                    let verticalId = $.getNewValFromForm('vertical-id');
                    let roleId = $.getNewValFromForm('role-id');
                    let anchorText = $.getNewValFromForm('anchor-value');

                    newAnchor = `<a class="nilink" href="" ${dispName}${prodId}${linkMediaType}${blrs}${siteId}${verticalId}${roleId} rel="nofollow noopener noreferrer" target="_blank">${anchorText}</a>`;

                    console.log('newAnchor =', newAnchor);

                    html = html.replace(textToReplaceArray[i], newAnchor);

                    $.cleanNewVals();

                    overlay.hide();
                    dialog.hide();
                }).catch(e => {
                    console.log('error =', e);
                    alert('closed');
                });

            }


            return html;

        };

        $.internalLinkConverter = async function (anchorHtml, anchorAttributes = '', anchorText) {
            console.log('in iternalLinkConverter');
            return anchorHtml;
        }

        $.convertProductLink = function (anchorHtml, anchorAttributes = '', anchorText) {
            console.log('in productLinkConverter');
            console.log('in convert anchorAttributes', anchorAttributes);

            const regexProductId = () => /data-product-id=["'](.*?)["']/m;
            const regexDisplayName = () => /data-display-name=["'](.*?)["']/m;
            const regexMediaType = () => /data-link-media-type=["'](.*?)["']/m;
            const regexBlrs = () => /data-data-blrs=["'](.*?)["']/m;
            const regexSiteId = () => /data-site-id=["'](.*?)["']/m;
            const regexVerticalId = () => /data-vertical-id=["'](.*?)["']/m;
            const regexRoleId = () => /data-role-id=["'](.*?)["']/m;


            const _regexProductId = regexProductId();
            const _regexDisplayName = regexDisplayName();
            const _regexMediaType = regexMediaType();
            const _regexBlrs = regexBlrs();
            const _regexSiteId = regexSiteId();
            const _regexVerticalId = regexVerticalId();
            const _regexRoleId = regexRoleId();


            const prodId = anchorAttributes.includes("data-product-id") ? _regexProductId.exec(anchorAttributes)[1] : null;
            const displayName = anchorAttributes.includes("data-display-name") ? _regexDisplayName.exec(anchorAttributes)[1] : null;
            const mediaType = anchorAttributes.includes("data-link-media-type") ? _regexMediaType.exec(anchorAttributes)[1] : null;
            const blrs = anchorAttributes.includes("data-data-blrs") ? _regexBlrs.exec(anchorAttributes)[1] : null;
            const siteId = anchorAttributes.includes("data-site-id") ? _regexSiteId.exec(anchorAttributes)[1] : null;
            const verticalId = anchorAttributes.includes("data-vertical-id") ? _regexVerticalId.exec(anchorAttributes)[1] : null;
            const roleId = anchorAttributes.includes("data-role-id") ? _regexRoleId.exec(anchorAttributes)[1] : null;

            return {
                "data-product-id": prodId,
                "data-display-name": displayName,
                "data-link-media-type": mediaType,
                "data-data-blrs": blrs,
                "data-site-id": siteId,
                "data-vertical-id": verticalId,
                "data-role-id": roleId,
                "data-anchor-value": anchorText
            }


        };

        function useExisting(id) {
            $(`#new-${id}`).val($(`#current-${id}`).val());
        }

        function cleanEmpty() {
            // alert('cleaning');
            let str = document.getElementById("input_text").value;
            const regex = /<a(.*?)href=(((?!img).)*?)\"><\/a>/g;
            const subst = ``;

            // The substituted value will be contained in the result variable
            const result = str.replace(regex, subst);
            console.log(result);
            //removing empty
            return result;

            //not removing empty
            // return str;
        }

        //modal
        $.product_modal = async function (anchorAttributes) {
            console.log('in modeal - anchorAttributes', anchorAttributes);

            var overlay = $("#overlay");
            var dialog = $("#dialog");

            $('#current-data-display-name').val(anchorAttributes['data-display-name']);
            $('#current-data-product-id').val(anchorAttributes['data-product-id']);
            $('#current-data-link-media-type').val(anchorAttributes['data-link-media-type']);
            $('#current-data-data-blrs').val(anchorAttributes['data-data-blrs']);
            $('#current-data-site-id').val(anchorAttributes['data-site-id']);
            $('#current-data-vertical-id').val(anchorAttributes['data-vertical-id']);
            $('#current-data-role-id').val(anchorAttributes['data-role-id']);

            let deferred = new $.Deferred();

            overlay.show();
            dialog.show();

            $(dialog).on("click", "#ok", deferred.resolve).on("click", "#cancel", deferred.reject);

            return deferred.promise();
        };

        $(function () {
            $("#btn").click(function async() {
                let html = cleanEmpty();
                $.LinkConverter(html).then(response => {
                    var overlay = $("#overlay");
                    var dialog = $("#dialog");

                    $("#output_text").val(response);

                    overlay.hide();
                    dialog.hide();
                }).catch(e => {
                    console.log(e);
                    alert('problem');
                });
            });
        });
    </script>
</head>

<body>
    <center>
        <h1>Oren's Wysiwyg HTML fixer</h1>
        <h3>No design yet, it was late...</h3>
        <h4>Before: (paste the damn thing here)</h4>
        <textarea id="input_text" rows="20" cols="100"></textarea><br />
        <button id="btn" style="margin: 5px 0px;">Fix Markup</button><br />
        <h4>After: (Click on the text, click Crtl/Command + a -> Crtl/Command + c and you can paset it back in the
            wysiwyg's code view</h4>
        <textarea id="output_text" rows="20" cols="100"></textarea><br />
    </center>

    <div class='overlay' id='overlay'></div>
    <div class='dialog' id='dialog'>
        <center>
            <h2>Fix link <span id='current'>1</span> out of <span id='links_count'>1</span></h2>
            <table border="2">
                <tr>
                    <th>Prop Name</th>
                    <th>Current Value</th>
                    <th>New Value</th>
                    <th>Action</th>
                </tr>
                <tr>
                    <td><label>Product Display Name (data-display-name)</label></td>
                    <td><input type='text' id='current-data-display-name'></td>
                    <td><input type='text' id='new-data-display-name'></td>
                    <td>
                        <button onclick="useExisting('data-display-name')">Use Current</button>
                    </td>
                </tr>
                <tr>
                    <td><label>Link Text</label></td>
                    <td><input type='text' id='current-data-anchor-value'></td>
                    <td><input type='text' id='new-data-anchor-value'></td>
                    <td>
                        <button onclick="useExisting('data-anchor-value')">Use Current</button>
                    </td>
                </tr>
                <tr>
                    <td><label>Product id (data-product-id)</label></td>
                    <td><input type='text' id='current-data-product-id'></td>
                    <td><input type='text' id='new-data-product-id'></td>
                    <td>
                        <button onclick="useExisting('data-product-id')">Use Current</button>
                    </td>
                </tr>
                <tr>
                    <td><label>Link media type (data-link-media-type)</label></td>
                    <td><input type='text' id='current-data-link-media-type'></td>
                    <td><input type='text' id='new-data-link-media-type'></td>
                    <td>
                        <button onclick="useExisting('data-link-media-type')">Use Current</button>
                    </td>
                </tr>
                <tr>
                    <td><label>Link BLRS (data-blrs)</label></td>
                    <td><input type='text' id='current-data-blrs'></td>
                    <td><input type='text' id='new-data-blrs'></td>
                    <td>
                        <button onclick="useExisting('data-blrs')">Use Current</button>
                    </td>
                </tr>
                <tr>
                    <td><label>Site ID (data-site-id)</label></td>
                    <td><input type='text' id='current-data-site-id'></td>
                    <td><input type='text' id='new-data-site-id'></td>
                    <td>
                        <button onclick="useExisting('data-site-id')">Use Current</button>
                    </td>
                </tr>
                <tr>
                    <td><label>Vertical id (data-vertical-id)</label></td>
                    <td><input type='text' id='current-data-vertical-id'></td>
                    <td><input type='text' id='new-data-vertical-id'></td>
                    <td>
                        <button onclick="useExisting('data-vertical-id')">Use Current</button>
                    </td>
                </tr>
                <tr>
                    <td><label>Role Id)</label></td>
                    <td><input type='text' id='current-data-role-id'></td>
                    <td><input type='text' id='new-data-role-id'></td>
                    <td>
                        <button onclick="useExisting('data-role-id')">Use Current</button>
                    </td>
                </tr>

            </table>
            <br />
            <br />
            <button id='ok'>Next</button>
            <button id='cancel'>Cancel</button>
        </center>
    </div>

</body>

</html>
